# Ð¢ÐµÑÑ‚Ñ‹ Ð´Ð»Ñ parser_tg_bot_flats

## Ð¡Ñ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð° Ñ‚ÐµÑÑ‚Ð¾Ð²

```
tests/
â”œâ”€â”€ __init__.py
â””â”€â”€ scrapers/
    â”œâ”€â”€ __init__.py
    â”œâ”€â”€ test_dto.py          # Ð¢ÐµÑÑ‚Ñ‹ Ð´Ð»Ñ ListingDTO
    â”œâ”€â”€ test_kufar.py        # Ð¢ÐµÑÑ‚Ñ‹ Ð´Ð»Ñ KufarScraper
    â”œâ”€â”€ test_etagi.py        # Ð¢ÐµÑÑ‚Ñ‹ Ð´Ð»Ñ EtagiScraper
    â”œâ”€â”€ test_realt.py        # Ð¢ÐµÑÑ‚Ñ‹ Ð´Ð»Ñ RealtByScraper
    â”œâ”€â”€ test_domovita.py     # Ð¢ÐµÑÑ‚Ñ‹ Ð´Ð»Ñ DomovitaScraper
    â”œâ”€â”€ test_gohome.py       # Ð¢ÐµÑÑ‚Ñ‹ Ð´Ð»Ñ GoHomeScraper
    â””â”€â”€ test_onliner.py      # Ð¢ÐµÑÑ‚Ñ‹ Ð´Ð»Ñ OnlinerRealtScraper
```

## Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹

### Ð‘Ð°Ð·Ð¾Ð²Ñ‹Ðµ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ (Ð²ÐºÐ»ÑŽÑ‡Ð°Ñ pytest)
```bash
pip install -r requirements.txt
```

### Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ Ð´Ð»Ñ Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸ (Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾)
```bash
pip install -r requirements-dev.txt
```

## Ð—Ð°Ð¿ÑƒÑÐº Ñ‚ÐµÑÑ‚Ð¾Ð²

### ðŸš€ Ð‘Ñ‹ÑÑ‚Ñ€Ñ‹Ð¹ ÑÑ‚Ð°Ñ€Ñ‚

**Ð’Ð°Ð¶Ð½Ð¾:** Ð¢ÐµÑÑ‚Ñ‹ Ð¿Ð¾Ð»Ð½Ð¾ÑÑ‚ÑŒÑŽ Ð¸Ð·Ð¾Ð»Ð¸Ñ€Ð¾Ð²Ð°Ð½Ñ‹ Ð¸ **ÐÐ• Ñ‚Ñ€ÐµÐ±ÑƒÑŽÑ‚**:
- Ð ÐµÐ°Ð»ÑŒÐ½Ñ‹Ñ… HTTP-Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð² (Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÑŽÑ‚ÑÑ Ð¼Ð¾ÐºÐ¸)
- Ð‘Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ… (Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÑŽÑ‚ÑÑ Ð¼Ð¾ÐºÐ¸)
- ÐŸÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ (.env)
- Ð¢Ð¾ÐºÐµÐ½Ð¾Ð² Telegram Ð¸Ð»Ð¸ Turso

Ð¢ÐµÑÑ‚Ñ‹ Ð¼Ð¾Ð¶Ð½Ð¾ Ð·Ð°Ð¿ÑƒÑÐºÐ°Ñ‚ÑŒ Ð² Ð»ÑŽÐ±Ð¾Ð¹ ÑÑ€ÐµÐ´Ðµ Ð±ÐµÐ· Ð´Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾Ð¹ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸!

### Ð¡Ð¿Ð¾ÑÐ¾Ð± 1: Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ ÑÐºÑ€Ð¸Ð¿Ñ‚Ð° (Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´ÑƒÐµÑ‚ÑÑ)

```bash
# Ð’ÑÐµ Ñ‚ÐµÑÑ‚Ñ‹
python run_tests.py

# Ð¡ Ð¿Ð¾ÐºÑ€Ñ‹Ñ‚Ð¸ÐµÐ¼ ÐºÐ¾Ð´Ð°
python run_tests.py --coverage

# Ð¢Ð¾Ð»ÑŒÐºÐ¾ unit-Ñ‚ÐµÑÑ‚Ñ‹
python run_tests.py --unit

# ÐšÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¹ Ð¼Ð¾Ð´ÑƒÐ»ÑŒ
python run_tests.py tests/scrapers/test_kufar.py

# Ð¢ÐµÑÑ‚Ñ‹ Ñ Ñ„Ð¸Ð»ÑŒÑ‚Ñ€Ð¾Ð¼ Ð¿Ð¾ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸ÑŽ
python run_tests.py -k kufar
```

### Ð¡Ð¿Ð¾ÑÐ¾Ð± 2: Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ bash-ÑÐºÑ€Ð¸Ð¿Ñ‚Ð° (Linux/Mac)

```bash
# Ð¡Ð´ÐµÐ»Ð°Ñ‚ÑŒ Ð¸ÑÐ¿Ð¾Ð»Ð½ÑÐµÐ¼Ñ‹Ð¼ (Ð¾Ð´Ð¸Ð½ Ñ€Ð°Ð·)
chmod +x run_tests.sh

# Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ Ð²ÑÐµ Ñ‚ÐµÑÑ‚Ñ‹
./run_tests.sh

# Ð¡ Ð¿Ð¾ÐºÑ€Ñ‹Ñ‚Ð¸ÐµÐ¼ ÐºÐ¾Ð´Ð°
./run_tests.sh tests/ -v --cov
```

### Ð¡Ð¿Ð¾ÑÐ¾Ð± 3: ÐŸÑ€ÑÐ¼Ð¾Ð¹ Ð·Ð°Ð¿ÑƒÑÐº Ñ‡ÐµÑ€ÐµÐ· pytest

```bash
# Ð’ÑÐµ Ñ‚ÐµÑÑ‚Ñ‹
pytest tests/

# ÐšÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¹ Ð¼Ð¾Ð´ÑƒÐ»ÑŒ
pytest tests/scrapers/test_kufar.py

# ÐšÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¹ Ñ‚ÐµÑÑ‚
pytest tests/scrapers/test_kufar.py::TestKufarScraper::test_fetch_listings_success

# Ð¡ Ð¿Ð¾Ð´Ñ€Ð¾Ð±Ð½Ñ‹Ð¼ Ð²Ñ‹Ð²Ð¾Ð´Ð¾Ð¼
pytest tests/ -v

# Ð¡ Ð¿Ð¾ÐºÑ€Ñ‹Ñ‚Ð¸ÐµÐ¼ ÐºÐ¾Ð´Ð°
pytest tests/ --cov=scrapers --cov-report=html

# Ð¢Ð¾Ð»ÑŒÐºÐ¾ Ð±Ñ‹ÑÑ‚Ñ€Ñ‹Ðµ Ñ‚ÐµÑÑ‚Ñ‹ (Ð±ÐµÐ· Ð¸Ð½Ñ‚ÐµÐ³Ñ€Ð°Ñ†Ð¸Ð¾Ð½Ð½Ñ‹Ñ…)
pytest tests/ -m "not slow"
```

## ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ

ÐŸÑ€Ð¾ÐµÐºÑ‚ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ `pytest.ini` Ð´Ð»Ñ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ pytest:
- ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ðµ Ð¾Ð±Ð½Ð°Ñ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ Ñ‚ÐµÑÑ‚Ð¾Ð²
- ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ð°ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð½Ñ‹Ñ… Ñ‚ÐµÑÑ‚Ð¾Ð²
- ÐœÐ°Ñ€ÐºÐµÑ€Ñ‹ Ð´Ð»Ñ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ð·Ð°Ñ†Ð¸Ð¸
- ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ð»Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ

## Ð˜Ð·Ð¾Ð»ÑÑ†Ð¸Ñ Ñ‚ÐµÑÑ‚Ð¾Ð²

### âœ… Ð§Ñ‚Ð¾ ÐÐ• Ñ‚Ñ€ÐµÐ±ÑƒÐµÑ‚ÑÑ:
- Ð ÐµÐ°Ð»ÑŒÐ½Ñ‹Ðµ HTTP-Ð·Ð°Ð¿Ñ€Ð¾ÑÑ‹ (Ð²ÑÐµ Ð¼Ð¾ÐºÐ¸Ñ€ÑƒÑŽÑ‚ÑÑ Ñ‡ÐµÑ€ÐµÐ· `AsyncMock`)
- Ð‘Ð°Ð·Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ… (Ð½Ðµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ Ð² Ñ‚ÐµÑÑ‚Ð°Ñ… Ð¿Ð°Ñ€ÑÐµÑ€Ð¾Ð²)
- ÐŸÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ (.env Ñ„Ð°Ð¹Ð»)
- Ð¢Ð¾ÐºÐµÐ½Ñ‹ (BOT_TOKEN, TURSO_AUTH_TOKEN)
- Ð¡ÐµÑ‚ÐµÐ²Ð¾Ðµ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ

### âœ… Ð§Ñ‚Ð¾ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ:
- ÐœÐ¾ÐºÐ¸ HTTP-ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð° (`unittest.mock.AsyncMock`)
- Ð¤Ð¸ÐºÑÑ‚ÑƒÑ€Ñ‹ pytest Ð´Ð»Ñ Ñ‚ÐµÑÑ‚Ð¾Ð²Ñ‹Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ…
- Ð˜Ð·Ð¾Ð»Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ Ñ‚ÐµÑÑ‚Ñ‹ Ð±ÐµÐ· Ð¿Ð¾Ð±Ð¾Ñ‡Ð½Ñ‹Ñ… ÑÑ„Ñ„ÐµÐºÑ‚Ð¾Ð²

## ÐŸÑ€Ð¸Ð¼ÐµÑ€Ñ‹ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ

### Ð¢ÐµÑÑ‚ Ð²Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ð¸ DTO
```python
def test_valid_dto():
    dto = ListingDTO(
        title="2-ÐºÐ¾Ð¼Ð½. ÐºÐ²Ð°Ñ€Ñ‚Ð¸Ñ€Ð°, 50 Ð¼Â²",
        price=50000,
        url="https://example.com/listing/123",
        location="ÐœÐ¸Ð½ÑÐº, ÑƒÐ». Ð›ÐµÐ½Ð¸Ð½Ð°, 1",
        source="test"
    )
    assert dto.title == "2-ÐºÐ¾Ð¼Ð½. ÐºÐ²Ð°Ñ€Ñ‚Ð¸Ñ€Ð°, 50 Ð¼Â²"
```

### Ð¢ÐµÑÑ‚ Ñ Ð¼Ð¾ÐºÐ¾Ð¼ HTTP
```python
@pytest.mark.asyncio
async def test_fetch_listings_success(scraper, mock_api_response):
    mock_client = AsyncMock()
    mock_client.fetch_json = AsyncMock(return_value=mock_api_response)
    scraper.http_client = mock_client
    
    listings = await scraper.fetch_listings()
    assert len(listings) > 0
```

## CI/CD Ð¸Ð½Ñ‚ÐµÐ³Ñ€Ð°Ñ†Ð¸Ñ

Ð¢ÐµÑÑ‚Ñ‹ Ð¼Ð¾Ð¶Ð½Ð¾ Ð»ÐµÐ³ÐºÐ¾ Ð¸Ð½Ñ‚ÐµÐ³Ñ€Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð² CI/CD Ð¿Ð°Ð¹Ð¿Ð»Ð°Ð¹Ð½Ñ‹:

```yaml
# ÐŸÑ€Ð¸Ð¼ÐµÑ€ Ð´Ð»Ñ GitHub Actions
- name: Run tests
  run: |
    pip install -r requirements.txt
    pytest tests/ -v
```

## ÐžÑ‚Ñ‡ÐµÑ‚ Ð¾ Ð¿Ð¾ÐºÑ€Ñ‹Ñ‚Ð¸Ð¸ ÐºÐ¾Ð´Ð°

ÐŸÐ¾ÑÐ»Ðµ Ð·Ð°Ð¿ÑƒÑÐºÐ° Ñ Ñ„Ð»Ð°Ð³Ð¾Ð¼ `--coverage`:
- Ð¢ÐµÑ€Ð¼Ð¸Ð½Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Ð¾Ñ‚Ñ‡ÐµÑ‚ Ð¿Ð¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÑ‚ÑÑ ÑÑ€Ð°Ð·Ñƒ
- HTML Ð¾Ñ‚Ñ‡ÐµÑ‚ ÑÐ¾Ñ…Ñ€Ð°Ð½ÑÐµÑ‚ÑÑ Ð² `htmlcov/index.html`
- ÐžÑ‚ÐºÑ€Ð¾Ð¹Ñ‚Ðµ `htmlcov/index.html` Ð² Ð±Ñ€Ð°ÑƒÐ·ÐµÑ€Ðµ Ð´Ð»Ñ Ð´ÐµÑ‚Ð°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ð¿Ñ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€Ð°

## ÐžÑÐ¾Ð±ÐµÐ½Ð½Ð¾ÑÑ‚Ð¸ Ñ‚ÐµÑÑ‚Ð¾Ð²

### ÐœÐ¾ÐºÐ¸ HTTP-Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð²
Ð’ÑÐµ Ñ‚ÐµÑÑ‚Ñ‹ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÑŽÑ‚ `unittest.mock` Ð´Ð»Ñ Ð¼Ð¾ÐºÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ HTTP-Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð²:
- `AsyncMock` Ð´Ð»Ñ Ð°ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð½Ñ‹Ñ… Ð¼ÐµÑ‚Ð¾Ð´Ð¾Ð²
- ÐœÐ¾ÐºÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ `HTTPClient` Ð¸ ÐµÐ³Ð¾ Ð¼ÐµÑ‚Ð¾Ð´Ð¾Ð² `fetch_html`, `fetch_json`
- ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð²Ñ‹Ð·Ð¾Ð²Ð¾Ð² Ð¼ÐµÑ‚Ð¾Ð´Ð¾Ð² Ð±ÐµÐ· Ñ€ÐµÐ°Ð»ÑŒÐ½Ñ‹Ñ… ÑÐµÑ‚ÐµÐ²Ñ‹Ñ… Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð²

### ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñ‹ ListingDTO
ÐšÐ°Ð¶Ð´Ñ‹Ð¹ Ñ‚ÐµÑÑ‚ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÑÐµÑ‚:
- Ð’Ð°Ð»Ð¸Ð´Ð½Ð¾ÑÑ‚ÑŒ Ð´Ð°Ð½Ð½Ñ‹Ñ… (title, price, url, location, source)
- ÐšÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð¾ÑÑ‚ÑŒ Ñ‚Ð¸Ð¿Ð¾Ð² Ð´Ð°Ð½Ð½Ñ‹Ñ…
- Ð’Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ÑÑ‚ÑŒ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ `ListingDTO` Ð¸Ð· `Listing`
- Ð¡Ð¾Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²Ð¸Ðµ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñ‹ Ð¾Ð¶Ð¸Ð´Ð°ÐµÐ¼Ð¾Ð¼Ñƒ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ñƒ

### Ð¢ÐµÑÑ‚Ð¸Ñ€ÑƒÐµÐ¼Ñ‹Ðµ ÑÑ†ÐµÐ½Ð°Ñ€Ð¸Ð¸
- Ð£ÑÐ¿ÐµÑˆÐ½Ð¾Ðµ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð¾Ð±ÑŠÑÐ²Ð»ÐµÐ½Ð¸Ð¹
- ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð¿ÑƒÑÑ‚Ñ‹Ñ… Ð¾Ñ‚Ð²ÐµÑ‚Ð¾Ð²
- ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð¾ÑˆÐ¸Ð±Ð¾Ðº HTTP
- ÐŸÐ°Ñ€ÑÐ¸Ð½Ð³ Ð²Ð°Ð»Ð¸Ð´Ð½Ñ‹Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ…
- ÐŸÐ°Ñ€ÑÐ¸Ð½Ð³ Ð¼Ð¸Ð½Ð¸Ð¼Ð°Ð»ÑŒÐ½Ñ‹Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ…
- Ð¤Ð¸Ð»ÑŒÑ‚Ñ€Ð°Ñ†Ð¸Ñ Ð¾Ð±ÑŠÑÐ²Ð»ÐµÐ½Ð¸Ð¹
- ÐŸÐ°Ð³Ð¸Ð½Ð°Ñ†Ð¸Ñ (Ð´Ð»Ñ Kufar)

## ÐŸÑ€Ð¸Ð¼ÐµÑ€Ñ‹ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ

### Ð¢ÐµÑÑ‚ Ð²Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ð¸ DTO
```python
def test_valid_dto():
    dto = ListingDTO(
        title="2-ÐºÐ¾Ð¼Ð½. ÐºÐ²Ð°Ñ€Ñ‚Ð¸Ñ€Ð°, 50 Ð¼Â²",
        price=50000,
        url="https://example.com/listing/123",
        location="ÐœÐ¸Ð½ÑÐº, ÑƒÐ». Ð›ÐµÐ½Ð¸Ð½Ð°, 1",
        source="test"
    )
    assert dto.title == "2-ÐºÐ¾Ð¼Ð½. ÐºÐ²Ð°Ñ€Ñ‚Ð¸Ñ€Ð°, 50 Ð¼Â²"
```

### Ð¢ÐµÑÑ‚ Ñ Ð¼Ð¾ÐºÐ¾Ð¼ HTTP
```python
@pytest.mark.asyncio
async def test_fetch_listings_success(scraper, mock_api_response):
    mock_client = AsyncMock()
    mock_client.fetch_json = AsyncMock(return_value=mock_api_response)
    scraper.http_client = mock_client
    
    listings = await scraper.fetch_listings()
    assert len(listings) > 0
```
